<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة المالك | School Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

<div class="max-w-6xl mx-auto p-6">

  <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">طلبات الأدمن الجديدة</h1>

  <div id="requestsContainer" class="space-y-4">
    <!-- هنا ستظهر الطلبات -->
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
  authDomain: "schoolmanager-1bab3.firebaseapp.com",
  projectId: "schoolmanager-1bab3",
  storageBucket: "schoolmanager-1bab3.firebasestorage.app",
  messagingSenderId: "365294333627",
  appId: "1:365294333627:web:b98978770a9e70adc7439e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const requestsContainer = document.getElementById("requestsContainer");

// تحميل الطلبات
async function loadRequests() {
  requestsContainer.innerHTML = "جاري تحميل الطلبات...";
  const snapshot = await getDocs(collection(db, "admins_requests"));
  requestsContainer.innerHTML = "";

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const docId = docSnap.id;

    const card = document.createElement("div");
    card.className = "bg-white p-4 rounded-2xl shadow flex flex-col md:flex-row justify-between items-start md:items-center gap-4";

    const info = document.createElement("div");
    info.innerHTML = `
      <p><strong>الاسم:</strong> ${data.fullName}</p>
      <p><strong>البريد:</strong> ${data.email}</p>
      <p><strong>الهاتف:</strong> ${data.phone}</p>
      <p><strong>تاريخ الطلب:</strong> ${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : ''}</p>
      ${data.paymentPhotoUrl ? `<img src="${data.paymentPhotoUrl}" class="mt-2 w-40 rounded shadow" />` : ''}
    `;

    const actions = document.createElement("div");
    actions.className = "flex gap-2";

    // زر قبول
    const acceptBtn = document.createElement("button");
    acceptBtn.className = "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700";
    acceptBtn.textContent = "قبول";
    acceptBtn.onclick = async () => {
      try {
        await addDoc(collection(db, "admins"), {
          fullName: data.fullName,
          email: data.email,
          phone: data.phone,
          createdAt: serverTimestamp(),
          approvedByOwner: true
        });
        await deleteDoc(doc(db, "admins_requests", docId));
        alert(`✅ تم قبول ${data.fullName}`);
        loadRequests();
      } catch (err) {
        console.error(err);
        alert("❌ حدث خطأ أثناء قبول الطلب");
      }
    };

    // زر رفض
    const rejectBtn = document.createElement("button");
    rejectBtn.className = "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700";
    rejectBtn.textContent = "رفض";
    rejectBtn.onclick = async () => {
      try {
        await deleteDoc(doc(db, "admins_requests", docId));
        alert(`❌ تم رفض ${data.fullName}`);
        loadRequests();
      } catch (err) {
        console.error(err);
        alert("❌ حدث خطأ أثناء رفض الطلب");
      }
    };

    actions.appendChild(acceptBtn);
    actions.appendChild(rejectBtn);

    card.appendChild(info);
    card.appendChild(actions);

    requestsContainer.appendChild(card);
  });

  if (snapshot.empty) requestsContainer.innerHTML = "<p class='text-gray-500 text-center'>لا توجد طلبات جديدة</p>";
}

loadRequests();
</script>

</body>
</html>