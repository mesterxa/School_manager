<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner Dashboard | School Manager</title>
<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
  authDomain: "schoolmanager-1bab3.firebaseapp.com",
  projectId: "schoolmanager-1bab3",
  storageBucket: "schoolmanager-1bab3.firebasestorage.app",
  messagingSenderId: "365294333627",
  appId: "1:365294333627:web:b98978770a9e70adc7439e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const adminsTable = document.getElementById("adminsTable");
const requestsTable = document.getElementById("requestsTable");
const addForm = document.getElementById("addForm");

// تحميل الأدمنز
async function loadAdmins() {
  adminsTable.innerHTML = "";
  const snapshot = await getDocs(collection(db, "admins"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.classList.add("border-b");
    tr.innerHTML = `
      <td class="px-4 py-2">${data.name}</td>
      <td class="px-4 py-2">${data.email}</td>
      <td class="px-4 py-2">${data.phone}</td>
      <td class="px-4 py-2">${data.schoolName}</td>
      <td class="px-4 py-2">
        <button data-id="${docSnap.id}" class="deleteBtn bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">حذف</button>
      </td>
    `;
    adminsTable.appendChild(tr);
  });

  document.querySelectorAll(".deleteBtn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      if (confirm("هل أنت متأكد من حذف هذا الأدمن؟")) {
        await deleteDoc(doc(db, "admins", id));
        loadAdmins();
      }
    });
  });
}

// تحميل طلبات التسجيل
async function loadRequests() {
  requestsTable.innerHTML = "";
  const snapshot = await getDocs(collection(db, "admin_requests"));
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement("tr");
    tr.classList.add("border-b");
    tr.innerHTML = `
      <td class="px-4 py-2">${data.name}</td>
      <td class="px-4 py-2">${data.email}</td>
      <td class="px-4 py-2">${data.phone}</td>
      <td class="px-4 py-2">${data.schoolName}</td>
      <td class="px-4 py-2 flex gap-2">
        <button data-id="${docSnap.id}" class="approveBtn bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">قبول</button>
        <button data-id="${docSnap.id}" class="rejectBtn bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500">رفض</button>
      </td>
    `;
    requestsTable.appendChild(tr);
  });

  // قبول الطلب
  document.querySelectorAll(".approveBtn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      const requestRef = doc(db, "admin_requests", id);
      const requestSnap = await getDocs(collection(db, "admin_requests"));
      const dataDoc = await requestRef.get?.() || { data: () => null };
      const data = dataDoc.data();
      if (!data || !data.password) return alert("كلمة المرور مفقودة!");
      await addDoc(collection(db, "admins"), {
        name: data.name,
        email: data.email,
        phone: data.phone,
        password: data.password,
        schoolName: data.schoolName,
        createdAt: serverTimestamp()
      });
      await updateDoc(requestRef, { approved: true });
      alert("تم قبول الأدمن ✅");
      loadAdmins();
      loadRequests();
    });
  });

  // رفض الطلب
  document.querySelectorAll(".rejectBtn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      if (confirm("هل تريد رفض هذا الطلب؟")) {
        await deleteDoc(doc(db, "admin_requests", id));
        loadRequests();
      }
    });
  });
}

// إضافة أدمن يدويًا
addForm.addEventListener("submit", async e => {
  e.preventDefault();
  const name = addForm.name.value.trim();
  const email = addForm.email.value.trim();
  const phone = addForm.phone.value.trim();
  const password = addForm.password.value.trim();
  const school = addForm.school.value.trim();

  if (!name || !email || !phone || !password || !school) return alert("يرجى ملء جميع الحقول");

  try {
    await addDoc(collection(db, "admins"), { name, email, phone, password, schoolName: school, createdAt: serverTimestamp() });
    alert("تم إضافة الأدمن بنجاح ✅");
    addForm.reset();
    loadAdmins();
  } catch(err) {
    console.error(err);
    alert("حدث خطأ أثناء إضافة الأدمن ❌");
  }
});

window.onload = () => {
  loadAdmins();
  loadRequests();
};
</script>
</head>

<body class="bg-gray-50 min-h-screen p-6">
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow">

<h1 class="text-2xl font-bold text-center mb-6 text-blue-600">لوحة تحكم المالك</h1>

<!-- إضافة أدمن يدويًا -->
<div class="mb-8">
  <h2 class="font-bold mb-3 text-lg">إضافة أدمن جديد يدويًا</h2>
  <form id="addForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <input name="name" placeholder="الاسم الكامل" class="p-2 border rounded">
    <input name="email" type="email" placeholder="البريد الإلكتروني" class="p-2 border rounded">
    <input name="phone" placeholder="رقم الهاتف" class="p-2 border rounded">
    <input name="password" type="password" placeholder="كلمة المرور" class="p-2 border rounded">
    <input name="school" placeholder="اسم المدرسة" class="p-2 border rounded md:col-span-2">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded md:col-span-2 hover:bg-blue-700">إضافة الأدمن</button>
  </form>
</div>

<!-- جدول الأدمنز -->
<h2 class="font-bold mb-3 text-lg">قائمة الأدمنز</h2>
<table class="w-full border-collapse text-right mb-6">
  <thead class="bg-gray-100">
    <tr>
      <th class="px-4 py-2">الاسم</th>
      <th class="px-4 py-2">البريد الإلكتروني</th>
      <th class="px-4 py-2">الهاتف</th>
      <th class="px-4 py-2">المدرسة</th>
      <th class="px-4 py-2">حذف</th>
    </tr>
  </thead>
  <tbody id="adminsTable"></tbody>
</table>

<!-- جدول طلبات التسجيل -->
<h2 class="font-bold mb-3 text-lg">طلبات تسجيل الأدمن</h2>
<table class="w-full border-collapse text-right">
  <thead class="bg-gray-100">
    <tr>
      <th class="px-4 py-2">الاسم</th>
      <th class="px-4 py-2">البريد الإلكتروني</th>
      <th class="px-4 py-2">الهاتف</th>
      <th class="px-4 py-2">المدرسة</th>
      <th class="px-4 py-2">قبول / رفض</th>
    </tr>
  </thead>
  <tbody id="requestsTable"></tbody>
</table>

</div>
</body>
</html>