<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owner Panel | School Manager</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
      authDomain: "schoolmanager-1bab3.firebaseapp.com",
      projectId: "schoolmanager-1bab3",
      storageBucket: "schoolmanager-1bab3.firebasestorage.app",
      messagingSenderId: "365294333627",
      appId: "1:365294333627:web:b98978770a9e70adc7439e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const OWNER_UID = "LnaJEMsXFJPiEDprpMS2CWgj0h92";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØµÙ„Ø§Ø­ÙŠØ© UID
    onAuthStateChanged(auth, async (user) => {
      if (!user || user.uid !== OWNER_UID) {
        alert("ğŸš« ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„");
        window.location.href = "./admin/loginowner.html";
      } else {
        await loadAdminRequests();
        await loadStats();
      }
    });

    // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logoutOwner = async () => {
      await signOut(auth);
      window.location.href = "./admin/loginowner.html";
    };

    // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª
    async function loadAdminRequests() {
      const container = document.getElementById("admin-requests");
      container.innerHTML = "âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

      const querySnapshot = await getDocs(collection(db, "admins_requests"));
      if (querySnapshot.empty) {
        container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>";
        return;
      }

      container.innerHTML = "";
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const requestCard = document.createElement("div");
        requestCard.className = "bg-white p-4 rounded-xl shadow mb-4 flex justify-between items-center";
        requestCard.innerHTML = `
          <div>
            <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${data.name}</p>
            <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${data.email}</p>
          </div>
          <div class="space-x-2">
            <button class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700" onclick="approveAdmin('${docSnap.id}')">Ù‚Ø¨ÙˆÙ„</button>
            <button class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" onclick="rejectAdmin('${docSnap.id}')">Ø±ÙØ¶</button>
          </div>
        `;
        container.appendChild(requestCard);
      });
    }

    // Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†
    async function approveAdmin(docId) {
      const docRef = doc(db, "admins_requests", docId);
      await updateDoc(docRef, { approved: true });
      alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†");
      await loadAdminRequests();
    }

    // Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†
    async function rejectAdmin(docId) {
      const docRef = doc(db, "admins_requests", docId);
      await deleteDoc(docRef);
      alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ­Ø°ÙÙ‡");
      await loadAdminRequests();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    async function loadStats() {
      const statsContainer = document.getElementById("stats-container");

      const adminsSnap = await getDocs(collection(db, "admins"));
      const studentsSnap = await getDocs(collection(db, "students"));
      const postsSnap = await getDocs(collection(db, "posts"));

      statsContainer.innerHTML = `
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª:</strong> ${adminsSnap.size}</p>
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨:</strong> ${studentsSnap.size}</p>
        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª:</strong> ${postsSnap.size}</p>
      `;
    }

  </script>
</head>

<body class="bg-gray-50 min-h-screen p-6">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-blue-600">Ù„ÙˆØ­Ø© Owner</h1>
    <button onclick="logoutOwner()" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-4">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <div id="admin-requests">
        âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
      </div>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
      <div id="stats-container">
        âš¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
      </div>
    </div>

  </div>

</body>
</html>