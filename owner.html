<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Owner Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
      authDomain: "schoolmanager-1bab3.firebaseapp.com",
      projectId: "schoolmanager-1bab3",
      storageBucket: "schoolmanager-1bab3.firebasestorage.app",
      messagingSenderId: "365294333627",
      appId: "1:365294333627:web:b98978770a9e70adc7439e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const OWNER_UID = "LnaJEMsXFJPiEDprpMS2CWgj0h92";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Owner
    onAuthStateChanged(auth, user => {
      if(!user || user.uid !== OWNER_UID){
        alert("ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙÙ‚Ø· Owner ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„");
        window.location.href = "../loginowner.html";
      } else {
        loadAdminRequests();
        loadAdminsTable();
      }
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.logoutOwner = async () => {
      await signOut(auth);
      window.location.href = "../loginowner.html";
    }

    // ====== 1. Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ======
    const requestsTable = document.getElementById("requests-table");

    async function loadAdminRequests(){
      const requestsRef = collection(db, "admins_requests");
      onSnapshot(requestsRef, snapshot => {
        requestsTable.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-100";
          tr.innerHTML = `
            <td class="px-4 py-2">${docSnap.id}</td>
            <td class="px-4 py-2">${data.name}</td>
            <td class="px-4 py-2">${data.email}</td>
            <td class="px-4 py-2">${data.schoolName}</td>
            <td class="px-4 py-2">
              <button class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" onclick='approveAdmin("${docSnap.id}", "${data.name}", "${data.email}", "${data.schoolName}")'>Ù‚Ø¨ÙˆÙ„</button>
              <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700" onclick='rejectAdmin("${docSnap.id}")'>Ø±ÙØ¶</button>
            </td>
          `;
          requestsTable.appendChild(tr);
        });
      });
    }

    async function approveAdmin(docId, name, email, schoolName){
      try{
        await addDoc(collection(db, "admins"), {
          name, email, schoolName, telegramBotToken: "", uid: ""
        });
        await deleteDoc(doc(db, "admins_requests", docId));
        alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† âœ…");
        loadAdminsTable();
      } catch(err){
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø¨ÙˆÙ„");
      }
    }

    async function rejectAdmin(docId){
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")){
        await deleteDoc(doc(db, "admins_requests", docId));
        alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ âœ…");
      }
    }

    // ====== 2. Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† + Ø­Ø°Ù + Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØª ======
    const adminsTable = document.getElementById("admins-table");

    async function loadAdminsTable(){
      const adminsRef = collection(db, "admins");
      onSnapshot(adminsRef, snapshot => {
        adminsTable.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-100";
          tr.innerHTML = `
            <td class="px-4 py-2">${docSnap.id}</td>
            <td class="px-4 py-2">${data.name}</td>
            <td class="px-4 py-2">${data.email}</td>
            <td class="px-4 py-2">${data.schoolName}</td>
            <td class="px-4 py-2">
              <input type="text" id="bot-${docSnap.id}" value="${data.telegramBotToken || ""}" placeholder="Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª" class="border px-2 py-1 rounded w-full">
              <div class="flex gap-2 mt-1">
                <button class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" onclick='updateBot("${docSnap.id}")'>Ø­ÙØ¸</button>
                <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700" onclick='deleteBot("${docSnap.id}")'>Ø­Ø°Ù</button>
              </div>
            </td>
            <td class="px-4 py-2">
              <button class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700" onclick='deleteAdmin("${docSnap.id}")'>Ø­Ø°Ù</button>
            </td>
          `;
          adminsTable.appendChild(tr);
        });
      });
    }

    // Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù†
    async function deleteAdmin(docId){
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ù…Ù†ØŸ")){
        await deleteDoc(doc(db, "admins", docId));
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù† âœ…");
      }
    }

    // ====== 3. Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ ======
    window.addManualAdmin = async () => {
      const name = document.getElementById("manual-name").value.trim();
      const email = document.getElementById("manual-email").value.trim();
      const schoolName = document.getElementById("manual-school").value.trim();

      if(!name || !email || !schoolName){
        alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
      }

      try{
        await addDoc(collection(db, "admins"), {
          name, email, schoolName, telegramBotToken: "", uid: ""
        });
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ù…Ù† âœ…");
        document.getElementById("manual-name").value = "";
        document.getElementById("manual-email").value = "";
        document.getElementById("manual-school").value = "";
        loadAdminsTable();
      } catch(err){
        console.error(err);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
      }
    }

    // ====== 4. Ø¥Ø¯Ø§Ø±Ø© Telegram Bot ======
    window.updateBot = async (docId) => {
      const token = document.getElementById(`bot-${docId}`).value.trim();
      await updateDoc(doc(db, "admins", docId), { telegramBotToken: token });
      alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙˆÙƒÙ† âœ…");
    }

    window.deleteBot = async (docId) => {
      if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø¨ÙˆØªØŸ")){
        await updateDoc(doc(db, "admins", docId), { telegramBotToken: "" });
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙˆÙƒÙ† âœ…");
      }
    }

  </script>
</head>
<body class="bg-gray-50 min-h-screen p-6">

  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-blue-600">Owner Dashboard</h1>
    <button onclick="logoutOwner()" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <!-- ====== Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====== -->
  <section class="mb-12">
    <h2 class="text-xl font-bold mb-2">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded-xl shadow">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Ø§Ù„Ø§Ø³Ù…</th>
            <th class="px-4 py-2">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
            <th class="px-4 py-2">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
            <th class="px-4 py-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="requests-table"></tbody>
      </table>
    </div>
  </section>

  <!-- ====== Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† ====== -->
  <section class="mb-12">
    <h2 class="text-xl font-bold mb-2">Ø§Ù„Ø£Ø¯Ù…Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h2>
    <div class="overflow-x-auto mb-4">
      <table class="min-w-full bg-white rounded-xl shadow">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-4 py-2">ID</th>
            <th class="px-4 py-2">Ø§Ù„Ø§Ø³Ù…</th>
            <th class="px-4 py-2">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
            <th class="px-4 py-2">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</th>
            <th class="px-4 py-2">Telegram Bot Token</th>
            <th class="px-4 py-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="admins-table"></tbody>
      </table>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§ -->
    <div class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-bold mb-2">Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù† ÙŠØ¯ÙˆÙŠÙ‹Ø§</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <input type="text" id="manual-name" placeholder="Ø§Ù„Ø§Ø³Ù…" class="border px-3 py-2 rounded w-full">
        <input type="email" id="manual-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="border px-3 py-2 rounded w-full">
        <input type="text" id="manual-school" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="border px-3 py-2 rounded w-full">
      </div>
      <button onclick="addManualAdmin()" class="mt-3 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </section>

</body>
</html>