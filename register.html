<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل أدمن جديد | EduDZ</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
  authDomain: "schoolmanager-1bab3.firebaseapp.com",
  projectId: "schoolmanager-1bab3",
  storageBucket: "schoolmanager-1bab3.appspot.com",
  messagingSenderId: "365294333627",
  appId: "1:365294333627:web:b98978770a9e70adc7439e"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

// بيانات البوت
const telegramToken = "8205787836:AAEgJSmusQzLonnQ7WeeR01RZ04YFhpxzA8";
const chatId = "6858411980"; // chat_id الخاص بالمالك

window.registerAdmin = async () => {
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const school = document.getElementById("school").value.trim();
  const receiptFile = document.getElementById("receipt").files[0];
  const messageBox = document.getElementById("welcome-message");

  if (!name || !email || !phone || !school || !receiptFile) {
    alert("⚠️ الرجاء ملء جميع الحقول وإرفاق صورة الوصل");
    return;
  }

  try {
    // 1️⃣ رفع صورة الوصل
    const storageRef = ref(storage, `admin_receipts/${Date.now()}_${receiptFile.name}`);
    await uploadBytes(storageRef, receiptFile);
    const receiptURL = await getDownloadURL(storageRef);

    // 2️⃣ حفظ البيانات في Firestore
    await addDoc(collection(db, "admin_requests"), {
      name,
      email,
      phone,
      schoolName: school,
      receiptURL,
      approved: false,
      createdAt: new Date()
    });

    // 3️⃣ إرسال إشعار للبوت
    const textMessage = `
طلب أدمن جديد!
الاسم: ${name}
البريد: ${email}
الهاتف: ${phone}
المدرسة: ${school}
[رابط الوصل](${receiptURL})
    `;
    await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: chatId,
        text: textMessage,
        parse_mode: "Markdown"
      })
    });

    // رسالة للمستخدم
    messageBox.innerHTML = `
      ✅ تم استلام طلبك لإدارة <strong>${school}</strong>.<br>
      يرجى الانتظار، سيتم مراجعة طلبك من طرف المالك قريبًا.
    `;
    messageBox.classList.remove("hidden");

    document.getElementById("admin-form").reset();

  } catch (error) {
    console.error(error);
    alert("❌ حدث خطأ أثناء إرسال الطلب، حاول مرة أخرى");
  }
}
</script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center">

<div class="bg-white p-8 rounded-2xl shadow-md w-full max-w-md">
  <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">تسجيل أدمن جديد</h1>

  <form id="admin-form" onsubmit="event.preventDefault(); registerAdmin();">

    <div class="mb-4">
      <label class="block mb-2 font-bold">الاسم الكامل</label>
      <input type="text" id="name" class="w-full p-2 border rounded" placeholder="أدخل الاسم">
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-bold">البريد الإلكتروني</label>
      <input type="email" id="email" class="w-full p-2 border rounded" placeholder="أدخل البريد">
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-bold">رقم الهاتف</label>
      <input type="tel" id="phone" class="w-full p-2 border rounded" placeholder="05xxxxxxxx">
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-bold">اسم المدرسة</label>
      <input type="text" id="school" class="w-full p-2 border rounded" placeholder="مثال: مدرسة النور">
    </div>

    <div class="mb-4">
      <label class="block mb-2 font-bold">صورة وصل الدفع (CCP)</label>
      <input type="file" id="receipt" accept="image/*" class="w-full p-2 border rounded">
    </div>

    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">تسجيل</button>
  </form>

  <div id="welcome-message" class="hidden mt-6 p-4 bg-green-100 text-green-800 rounded text-center"></div>
</div>

</body>
</html>