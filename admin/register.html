<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุชุณุฌูู ุฃุฏูู ุฌุฏูุฏ | School Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">

<div class="bg-white p-8 rounded-2xl shadow-md w-full max-w-md">
  <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">ุชุณุฌูู ุฃุฏูู ุฌุฏูุฏ</h1>

  <form id="adminForm" class="space-y-4">
    <div>
      <label class="block mb-1 font-semibold">ุงูุงุณู ุงููุงูู</label>
      <input type="text" id="fullName" required class="w-full p-2 border rounded" placeholder="ูุซุงู: ูุญูุฏ ุฃุญูุฏ">
    </div>

    <div>
      <label class="block mb-1 font-semibold">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
      <input type="email" id="email" required class="w-full p-2 border rounded" placeholder="ูุซุงู: example@mail.com">
    </div>

    <div>
      <label class="block mb-1 font-semibold">ุฑูู ุงููุงุชู</label>
      <input type="tel" id="phone" required class="w-full p-2 border rounded" placeholder="05xxxxxxxx">
    </div>

    <div>
      <label class="block mb-1 font-semibold">ุตูุฑุฉ ุงููุตู (CCP)</label>
      <input type="file" id="paymentPhoto" accept="image/*" required class="w-full p-2 border rounded">
    </div>

    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ุชุณุฌูู</button>
  </form>

  <div id="waitingMessage" class="hidden mt-4 p-4 bg-yellow-100 text-yellow-800 rounded text-center">
    โณ ุฌุงุฑู ูุนุงูุฌุฉ ุทูุจูุ ูุฑุฌู ุงูุงูุชุธุงุฑ...
  </div>
</div>

<script type="module">
// Firebase (Firestore ููุท ูุชุฎุฒูู ุงูุทูุจ)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ุฅุนุฏุงุฏ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCODe3VO-CPq-029218YsgaUQ9MKp90E3k",
  authDomain: "schoolmanager-1bab3.firebaseapp.com",
  projectId: "schoolmanager-1bab3",
  storageBucket: "schoolmanager-1bab3.firebasestorage.app",
  messagingSenderId: "365294333627",
  appId: "1:365294333627:web:b98978770a9e70adc7439e"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Telegram
const TELEGRAM_BOT_TOKEN = "8205787836:AAEgJSmusQzLonnQ7WeeR01RZ04YFhpxzA8";
const TELEGRAM_CHAT_ID = "6858411980";

// Form handler
document.getElementById("adminForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const fullName = document.getElementById("fullName").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const photo = document.getElementById("paymentPhoto").files[0];

  if (!fullName || !email || !phone || !photo) return alert("โ๏ธ ูุฑุฌู ููุก ุฌููุน ุงูุญููู");

  // ุฅุธูุงุฑ ุฑุณุงูุฉ ุงูุงูุชุธุงุฑ
  const waiting = document.getElementById("waitingMessage");
  waiting.classList.remove("hidden");

  try {
    // ุฑูุน ุงูุทูุจ ุฅูู Firestore
    const formData = new FormData();
    formData.append("file", photo);
    formData.append("upload_preset", "schoolmanager"); // ูููู ุงุณุชุฎุฏุงู Cloudinary ุฃู Firebase Storage ูุงุญููุง

    // ุฅุฑุณุงู ุฅูู Firestore
    await addDoc(collection(db, "admins_requests"), {
      fullName,
      email,
      phone,
      createdAt: serverTimestamp()
    });

    // ุฅุฑุณุงู ุฅูู Telegram
    const reader = new FileReader();
    reader.onload = async () => {
      const base64 = reader.result.split(",")[1]; // ุฅุฒุงูุฉ ุงูุจุงุฏุฆุฉ data:image/...
      const caption = `๐ ุทูุจ ุฃุฏูู ุฌุฏูุฏ\n\nุงูุงุณู: ${fullName}\nุงูุจุฑูุฏ: ${email}\nุงููุงุชู: ${phone}`;
      
      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHAT_ID,
          photo: `data:${photo.type};base64,${base64}`,
          caption
        })
      });
    };
    reader.readAsDataURL(photo);

    // ุฑุณุงูุฉ ูุคูุชุฉ ูุงูุชูุงู ุจุนุฏ 2 ุซุงููุฉ
    setTimeout(() => {
      alert("โ ุชู ุฅุฑุณุงู ุทูุจู ูููุงูู. ุณูุชู ูุฑุงุฌุนุชู ูุฑูุจูุง!");
      window.location.href = "../index.html"; // ุงูุนูุฏุฉ ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
    }, 2000);

  } catch (err) {
    console.error(err);
    alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุณุฌูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.");
    waiting.classList.add("hidden");
  }
});
</script>

</body>
</html>